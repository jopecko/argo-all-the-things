version: '3'

vars:
  CLUSTER_NAME: argo-all-the-things

tasks:
  create-cluster:
    run: once
    cmds:
      - k3d cluster create {{.CLUSTER_NAME}} --api-port 6443 -p 8080:80@loadbalancer
    vars:
      NUM_WORKER_NODES: 3

  destroy-cluster:
    cmds:
      - k3d cluster delete {{.CLUSTER_NAME}}

  install-tooling:
    dir: ./terraform/infra
    cmds:
      - terraform init
      - terraform apply --auto-approve

  uninstall-tooling:
    dir: ./terraform/infra
    cmds:
      - terraform destroy --auto-approve

  up:
    cmds:
      - task: create-cluster
      - task: install-tooling

  down:
    cmds:
      - task: uninstall-tooling
      - task: destroy-cluster
